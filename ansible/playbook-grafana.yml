---
- name: Deploy Grafana cluster
  hosts: cluster
  become: yes
  vars_files:
    - "group_vars/grafana.yml"
  
  collections:
    - grafana.grafana

  tasks:
    - name: Wait for Grafana to start
      wait_for:
        port: "{{ grafana_server_http_port }}"
        host: "{{ inventory_hostname }}"
        delay: 10
        timeout: 60

    - name: Check Grafana health
      uri:
        url: "http://{{ inventory_hostname }}:{{ grafana_server_http_port }}/api/health"
        method: GET
        status_code: 200
        timeout: 10
      register: health_check
      until: health_check.status == 200
      retries: 5
      delay: 10