- name: Install HAProxy
  package:
    name: haproxy
    state: present

- name: Create HAProxy configuration directory
  file:
    path: "/etc/haproxy"
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Configure HAProxy
  template:
    src: haproxy.cfg.j2
    dest: "/etc/haproxy/haproxy.cfg"
    owner: root
    group: root
    mode: '0644'
  notify: restart haproxy

- name: Enable HAProxy
  lineinfile:
    path: /etc/default/haproxy
    regexp: '^ENABLED='
    line: 'ENABLED=1'
    state: present

- name: Configure HAProxy log
  lineinfile:
    path: /etc/rsyslog.conf
    line: '$ModLoad imudp\n$UDPServerRun 514'
    state: present
  notify: restart rsyslog

- name: Configure HAProxy logging
  copy:
    content: |
      local0.* -/var/log/haproxy.log
    dest: /etc/rsyslog.d/49-haproxy.conf
    owner: root
    group: root
    mode: '0644'
  notify: restart rsyslog

- name: Create HAProxy log file
  file:
    path: /var/log/haproxy.log
    state: touch
    owner: syslog
    group: adm
    mode: '0644'

- name: Start and enable HAProxy
  systemd:
    name: haproxy
    state: started
    enabled: true

- name: Wait for HAProxy to start
  wait_for:
    port: "{{ haproxy_frontend_port }}"
    host: "{{ inventory_hostname }}"
    delay: 5
    state: started

- name: Wait for HAProxy stats
  wait_for:
    port: "{{ haproxy_stats_port }}"
    host: "{{ inventory_hostname }}"
    delay: 5
    state: started

- name: Test HAProxy stats page
  uri:
    url: "http://{{ inventory_hostname }}:{{ haproxy_stats_port }}/"
    method: GET
    user: "{{ haproxy_stats_user }}"
    password: "{{ haproxy_stats_password }}"
    force_basic_auth: true
    status_code: 200
  register: haproxy_test
  failed_when: haproxy_test.failed

- name: Check PostgreSQL backend status
  uri:
    url: "http://{{ inventory_hostname }}:{{ haproxy_stats_port }}/;csv"
    method: GET
    user: "{{ haproxy_stats_user }}"
    password: "{{ haproxy_stats_password }}"
    force_basic_auth: true
  register: haproxy_stats
  failed_when: false

- name: Display HAProxy status
  debug:
    msg: "HAProxy is running and configured with {{ haproxy_stats.content | length }} backends"